<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Dashboard Pro</title>
    <style>
        /* TEMA TERANG & GELAP DENGAN CSS VARIABLES */
        :root {
            --primary: #4CAF50; --primary-hover: #45a049;
            --bg: #f4f7f6; --card: #ffffff;
            --text-dark: #333333; --text-muted: #666666; 
            --warning: #ff9800; --border: #eeeeee;
        }
        
        body.dark-mode {
            --bg: #121212; --card: #1e1e1e;
            --text-dark: #f0f0f0; --text-muted: #aaaaaa; 
            --border: #333333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg); color: var(--text-dark);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            transition: background-color 0.3s, color 0.3s;
        }

        .dashboard { width: 100%; max-width: 450px; display: flex; flex-direction: column; gap: 20px; }
        
        .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .greeting-text { font-size: 22px; font-weight: bold; margin: 0; }
        .quote-text { font-size: 13px; color: var(--text-muted); font-style: italic; margin-top: 5px; }
        .btn-icon { background: var(--card); border: 1px solid var(--border); color: var(--text-dark); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-icon:hover { background: var(--border); }

        .stats-row { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 10px 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .streak-badge { font-weight: bold; color: #ff5722; display: flex; align-items: center; gap: 5px; }

        .card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: background-color 0.3s; }
        h2 { margin: 0 0 15px 0; font-size: 18px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--border); padding-bottom: 10px;}
        .subtitle { font-size: 13px; color: var(--text-muted); margin-bottom: 15px; }

        /* Zona Kemarin & Snooze */
        .missed-list { list-style: none; padding: 0; margin: 0; }
        .missed-list li { padding: 10px 0; border-bottom: 1px dashed var(--border); display: flex; justify-content: space-between; align-items: center; gap: 8px; font-size: 14px;}
        .missed-list li:last-child { border-bottom: none; }
        .task-name-missed { color: var(--warning); font-weight: 500; display: flex; align-items: center; gap: 5px; }
        .btn-snooze { background: #e3f2fd; color: #1976d2; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; }
        body.dark-mode .btn-snooze { background: #1976d2; color: #fff; }

        /* Zona Hari Ini */
        .progress-bar { height: 8px; background: var(--border); border-radius: 4px; margin-bottom: 20px; overflow: hidden;}
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .habit-list { list-style: none; padding: 0; margin: 0; }
        .habit-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .habit-info { display: flex; align-items: center; gap: 12px; flex: 1; }
        input[type="checkbox"] { width: 22px; height: 22px; accent-color: var(--primary); cursor: pointer; }
        .tag-badge { font-size: 11px; padding: 3px 6px; border-radius: 4px; font-weight: bold; }
        .action-btns button { background: none; border: none; cursor: pointer; opacity: 0.5; color: var(--text-dark); }
        .action-btns button:hover { opacity: 1; }

        /* Input Multi-fungsi */
        .add-habit { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; background: var(--bg); padding: 10px; border-radius: 8px; }
        .input-group { display: flex; gap: 8px; }
        .add-habit input, .add-habit select { padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text-dark); outline: none; }
        .add-habit input { flex: 1; }
        .btn-add { background: var(--primary); color: white; border: none; border-radius: 6px; padding: 10px 15px; cursor: pointer; font-weight: bold; }

        /* Agenda Besok */
        .agenda-input textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; resize: vertical; min-height: 70px; font-family: inherit; box-sizing: border-box; background: var(--bg); color: var(--text-dark); outline: none; margin-bottom: 10px;}
        .btn-agenda { background: #2196F3; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%;}

        /* Tombol Simpan Utama */
        .btn-sync { background: var(--text-dark); color: var(--card); border: none; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.1);}
        .btn-sync:hover { transform: translateY(-2px); opacity: 0.9; }
        
        #loading { display: none; text-align: center; padding: 10px; color: var(--primary); font-weight: bold; font-size: 14px;}
        .completed-text { text-decoration: line-through; color: var(--text-muted); }
    </style>
</head>
<body>

<div class="dashboard">

    <div class="header-nav">
        <div>
            <h1 class="greeting-text" id="greetingText">Selamat Pagi!</h1>
            <div class="quote-text" id="quoteText">"Satu langkah kecil lebih baik daripada tidak sama sekali."</div>
        </div>
        <button class="btn-icon" onclick="toggleDarkMode()" id="darkModeBtn">üåô</button>
    </div>

    <div class="stats-row">
        <div class="streak-badge">üî• Streak: <span id="streakCount">0</span> Hari</div>
        <div style="font-size: 13px; color: var(--text-muted);" id="dateTodayHeader"></div>
    </div>

    <div id="loading">Menyinkronkan data server... ‚è≥</div>

    <div class="card">
        <h2>‚è™ Evaluasi Kemarin</h2>
        <ul class="missed-list" id="missedList">
            </ul>
    </div>

    <div class="card">
        <h2>üéØ Fokus Hari Ini</h2>
        
        <div id="todayAgendaContainer" style="display:none; background: rgba(33, 150, 243, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #2196F3;">
            <strong style="color: #1976d2; font-size: 13px;">üìå Agenda Khusus Hari Ini:</strong>
            <ul id="todayAgendaList" style="margin: 5px 0 0; padding-left: 20px; font-size: 14px; color: var(--text-dark);"></ul>
        </div>

        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        
        <ul class="habit-list" id="habitList"></ul>

        <div class="add-habit">
            <div class="input-group">
                <input type="text" id="newHabitInput" placeholder="Ketik rutinitas baru...">
            </div>
            <div class="input-group">
                <select id="tagInput">
                    <option value="Pondok">üü¢ Pondok</option>
                    <option value="Angkatan">üîµ Angkatan</option>
                    <option value="Pribadi">üü† Pribadi</option>
                    <option value="Lainnya" selected>‚ö™ Lainnya</option>
                </select>
                <button class="btn-add" onclick="addHabit()">Tambah</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>‚è© Catatan & Agenda Besok</h2>
        <div class="agenda-input">
            <textarea id="agendaTomorrow" placeholder="Tulis hal penting yang harus dikerjakan besok..."></textarea>
            <button class="btn-agenda" onclick="saveAgenda()">Simpan Agenda Besok</button>
        </div>
    </div>

    <button class="btn-sync" id="btnSync" onclick="saveToday()">Simpan Rekap Hari Ini ke Database</button>

</div>

<script>
    // ======================================================================
    // PASTE URL APPS SCRIPT ANDA DI ANTARA TANDA KUTIP DI BAWAH INI:
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzxmna0szVmBrWhMmznXkuq519TRzahIJDzBhrmEnM5b6g0GOEuzzuwmRpP5z_ndSb5UQ/exec"; 
    // ======================================================================

    // 1. PENGATURAN AWAL & WAKTU
    const today = new Date();
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    document.getElementById('dateTodayHeader').innerText = today.toLocaleDateString('id-ID', options);

    // Sapaan Dinamis
    const hour = today.getHours();
    let greeting = "Selamat Pagi!";
    if (hour >= 11 && hour < 15) greeting = "Selamat Siang!";
    else if (hour >= 15 && hour < 18) greeting = "Selamat Sore!";
    else if (hour >= 18) greeting = "Selamat Malam!";
    document.getElementById('greetingText').innerText = greeting;

    // Mode Gelap (Dark Mode)
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeBtn').innerText = '‚òÄÔ∏è';
    }
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('darkMode', isDark);
        document.getElementById('darkModeBtn').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
    }

    // Generator Suara "Ting!"
    function playSound() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gainNode = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, ctx.currentTime); // Nada A5
        gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
        osc.connect(gainNode);
        gainNode.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.5);
    }

    // Sistem Streak
    let streakCount = parseInt(localStorage.getItem('streakCount')) || 0;
    document.getElementById('streakCount').innerText = streakCount;

    function updateStreak(isAllCompleted) {
        if (isAllCompleted) {
            streakCount++;
            localStorage.setItem('streakCount', streakCount);
            document.getElementById('streakCount').innerText = streakCount;
        }
    }

// 2. MANAJEMEN DATA HABIT
    // Saya ubah nama penyimpanannya menjadi 'myHabitsFinal' agar sistem memuat kategori baru ini dengan bersih
    let habits = JSON.parse(localStorage.getItem('myHabitsFinal')) || [
        { name: "Pantau kegiatan anak-anak", status: false, tag: "Pondok", color: "#4CAF50" },
        { name: "Rapat koordinasi Drama Arena 5101", status: false, tag: "Angkatan", color: "#2196F3" },
        { name: "Progres bab skripsi", status: false, tag: "Pribadi", color: "#FF9800" },
        { name: "Mabar Bareng Squad SOLE - Saudi De Familia", status: false, tag: "Lainnya", color: "#9E9E9E" }
    ];

    const tagColors = { "Pondok": "#4CAF50", "Angkatan": "#2196F3", "Pribadi": "#FF9800", "Lainnya": "#9E9E9E" };    function saveAndRender() {
        localStorage.setItem('myHabitsPro', JSON.stringify(habits));
        renderHabits();
    }

    function renderHabits() {
        const habitListEl = document.getElementById('habitList');
        habitListEl.innerHTML = '';
        let completed = 0;

        habits.forEach((h, i) => {
            if (h.status) completed++;
            const textClass = h.status ? 'completed-text' : '';
            habitListEl.innerHTML += `
                <li class="habit-item">
                    <div class="habit-info">
                        <input type="checkbox" onchange="toggleHabit(${i})" ${h.status ? 'checked' : ''}>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <span class="${textClass}" style="font-weight: 500;">${h.name}</span>
                            <span class="tag-badge" style="background: ${h.color}20; color: ${h.color}; width: fit-content;">${h.tag}</span>
                        </div>
                    </div>
                    <div class="action-btns">
                        <button onclick="deleteHabit(${i})" title="Hapus Tugas">üóëÔ∏è</button>
                    </div>
                </li>
            `;
        });

        // Update Progress Bar
        const percentage = habits.length ? (completed / habits.length) * 100 : 0;
        document.getElementById('progressFill').style.width = percentage + '%';
    }

    function toggleHabit(i) { 
        habits[i].status = !habits[i].status; 
        if(habits[i].status) playSound(); // Mainkan suara jika dicentang
        saveAndRender(); 
    }

    function addHabit() {
        const name = document.getElementById('newHabitInput').value.trim();
        const tag = document.getElementById('tagInput').value;
        if (name) { 
            habits.push({ name: name, status: false, tag: tag, color: tagColors[tag] }); 
            document.getElementById('newHabitInput').value = ""; 
            saveAndRender(); 
        }
    }

    function deleteHabit(i) {
        if(confirm("Hapus tugas ini?")) { habits.splice(i, 1); saveAndRender(); }
    }

    // 3. FITUR SERVER & SNOOZE
    function fetchServerData() {
        if(SCRIPT_URL.includes("PASTE_URL")) return; 
        
        document.getElementById('loading').style.display = 'block';
        
        fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                
                const missedUl = document.getElementById('missedList');
                if (data.kemarinBelumSelesai && data.kemarinBelumSelesai.length > 0) {
                    missedUl.innerHTML = data.kemarinBelumSelesai.map(task => `
                        <li>
                            <span class="task-name-missed">‚ö†Ô∏è ${task}</span>
                            <button class="btn-snooze" onclick="snoozeTask('${task}')">Tunda ‚û°Ô∏è</button>
                        </li>
                    `).join('');
                } else {
                    missedUl.innerHTML = '<li style="color: var(--primary); font-style: italic;">Luar biasa! Kemarin semua tugas tuntas. üéâ</li>';
                }

                const agendaContainer = document.getElementById('todayAgendaContainer');
                if (data.agendaHariIni && data.agendaHariIni.length > 0) {
                    agendaContainer.style.display = 'block';
                    document.getElementById('todayAgendaList').innerHTML = data.agendaHariIni.map(task => `<li>${task}</li>`).join('');
                }
            }).catch(err => {
                document.getElementById('loading').innerText = 'Gagal memuat data evaluasi.';
            });
    }

    // Fungsi Tombol Tunda (Memindahkan teks ke kolom Agenda Besok)
    window.snoozeTask = function(taskName) {
        const textarea = document.getElementById('agendaTomorrow');
        const currentText = textarea.value;
        textarea.value = currentText ? currentText + '\n- Lanjutan: ' + taskName : '- Lanjutan: ' + taskName;
        alert(`Tugas "${taskName}" ditambahkan ke draf Agenda Besok. Jangan lupa klik 'Simpan Agenda' ya!`);
    }

    function saveToday() {
        const btn = document.getElementById('btnSync');
        btn.innerText = "Menyimpan... ‚è≥";
        
        const payload = { action: "saveToday", data: habits };

        fetch(SCRIPT_URL, {
            method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            alert("Rekap hari ini masuk Database!");
            btn.innerText = "Tersimpan ‚úì";
            btn.style.background = "var(--primary)";
            
            // Cek apakah semua selesai untuk menambah Streak
            const isAllCompleted = habits.every(h => h.status === true);
            if(isAllCompleted && habits.length > 0) {
                updateStreak(true);
                alert("üî• Sempurna! Semua tugas selesai, Streak Anda bertambah!");
            }

            setTimeout(() => { btn.innerText = "Simpan Rekap Hari Ini ke Database"; btn.style.background = "var(--text-dark)"; }, 3000);
            
            if(confirm("Reset semua centang untuk persiapan besok?")) {
                habits.forEach(h => h.status = false);
                saveAndRender();
            }
        });
    }

    function saveAgenda() {
        const text = document.getElementById('agendaTomorrow').value.trim();
        if(!text) { alert("Isi agenda dulu!"); return; }
        
        const btn = document.querySelector('.btn-agenda');
        btn.innerText = "Menyimpan... ‚è≥";

        const payload = { action: "saveTomorrow", agenda: text };

        fetch(SCRIPT_URL, {
            method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            alert("Agenda untuk besok berhasil dicatat di Server!");
            document.getElementById('agendaTomorrow').value = "";
            btn.innerText = "Simpan Agenda Besok";
        });
    }

    // Inisialisasi Aplikasi
    renderHabits();
    fetchServerData();

</script>

</body>
</html>