<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Personal Dashboard Pro</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%2381C784'/><stop offset='100%' stop-color='%232E7D32'/></linearGradient></defs><rect width='100' height='100' rx='24' fill='url(%23g)'/><path d='M28 53 l15 15 l30 -30' fill='none' stroke='%23ffffff' stroke-width='12' stroke-linecap='round' stroke-linejoin='round'/></svg>">
    
    <style>
        :root {
            --primary: #4CAF50; --bg: #f4f7f6; --card: #ffffff;
            --text-dark: #333333; --text-muted: #666666; 
            --warning: #ff9800; --border: #eeeeee; --blue: #2196F3;
        }
        
        body.dark-mode { --bg: #121212; --card: #1e1e1e; --text-dark: #f0f0f0; --text-muted: #aaaaaa; --border: #333333; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text-dark); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; transition: 0.3s; }
        .dashboard { width: 100%; max-width: 450px; display: flex; flex-direction: column; gap: 20px; }
        
        /* HEADER & TAB MENU */
        .header-nav { display: flex; justify-content: space-between; align-items: center; }
        .greeting-text { font-size: 22px; font-weight: bold; margin: 0; }
        .quote-text { font-size: 13px; color: var(--text-muted); font-style: italic; margin-top: 5px; }
        .btn-icon { background: var(--card); border: 1px solid var(--border); color: var(--text-dark); padding: 8px 12px; border-radius: 8px; cursor: pointer; }
        
        .tab-menu { display: flex; background: var(--border); padding: 5px; border-radius: 12px; margin-top: 5px; }
        .tab-btn { flex: 1; text-align: center; padding: 12px; border-radius: 8px; font-weight: bold; color: var(--text-muted); cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--card); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        .view-section { display: none; flex-direction: column; gap: 20px; animation: fadeIn 0.3s; }
        .view-section.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* KARTU UMUM */
        .card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { margin: 0 0 15px 0; font-size: 17px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--border); padding-bottom: 10px;}
        
        /* KOMPONEN DAILY */
        .missed-list { list-style: none; padding: 0; margin: 0; }
        .missed-list li { padding: 10px 0; border-bottom: 1px dashed var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 14px;}
        .task-name-missed { color: var(--warning); font-weight: 500; }
        .btn-snooze { background: #e3f2fd; color: #1976d2; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .agenda-input textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; resize: vertical; min-height: 70px; background: var(--bg); color: var(--text-dark); box-sizing: border-box; margin-bottom: 10px;}
        .btn-agenda { background: var(--blue); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%;}
        
        /* HABIT LIST & AGENDA KHUSUS */
        .progress-bar { height: 8px; background: var(--border); border-radius: 4px; margin-bottom: 20px; overflow: hidden;}
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s; }
        .habit-list { list-style: none; padding: 0; margin: 0; }
        .habit-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .habit-info { display: flex; align-items: center; gap: 12px; flex: 1; }
        input[type="checkbox"] { width: 22px; height: 22px; accent-color: var(--primary); cursor: pointer; }
        .tag-badge { font-size: 11px; padding: 3px 6px; border-radius: 4px; font-weight: bold; }
        .add-habit, .event-form { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; background: var(--bg); padding: 10px; border-radius: 8px;}
        .input-group { display: flex; gap: 8px; }
        input[type="text"], input[type="time"], select { padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text-dark); flex: 1; outline: none;}
        .btn-add { background: var(--primary); color: white; border: none; border-radius: 6px; padding: 10px 15px; font-weight: bold; cursor: pointer;}
        .btn-sync { background: var(--text-dark); color: var(--card); border: none; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer;}

        /* EVENT RUNDOWN */
        .countdown-box { background: var(--blue); color: white; padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; margin-bottom: 10px;}
        .countdown-time { font-size: 26px; margin: 5px 0; }
        
        .timeline { position: relative; padding-left: 20px; margin-top: 10px; }
        .timeline::before { content: ''; position: absolute; left: 7px; top: 0; bottom: 0; width: 2px; background: var(--border); }
        
        .event-item { position: relative; margin-bottom: 15px; padding: 12px; border-radius: 12px; background: var(--bg); border: 1px solid var(--border); transition: 0.3s;}
        .event-item::before { content: ''; position: absolute; left: -19px; top: 18px; width: 10px; height: 10px; border-radius: 50%; background: var(--border); border: 2px solid var(--card); }
        .event-item.active { border-left: 4px solid var(--primary); background: rgba(76, 175, 80, 0.05); }
        .event-item.active::before { background: var(--primary); box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.2); }
        .event-item.past { opacity: 0.5; }

        .event-header { display: flex; justify-content: space-between; align-items: flex-start;}
        .event-time { font-size: 12px; color: var(--primary); font-weight: bold; margin-bottom: 4px; }
        .event-title { font-size: 15px; font-weight: bold; margin: 0 0 4px 0;}
        .event-desc { font-size: 13px; color: var(--text-muted); margin: 0; line-height: 1.4; }
        .event-actions button { background: none; border: none; font-size: 14px; cursor: pointer; padding: 2px; }
        
        #loading { display: none; text-align: center; padding: 10px; color: var(--primary); font-weight: bold; font-size: 14px;}
    </style>
</head>
<body>

<div class="dashboard">
    <div class="header-nav">
        <div>
            <h1 class="greeting-text" id="greetingText">Selamat Pagi!</h1>
            <div class="quote-text" id="dateTodayHeader"></div>
        </div>
        <button class="btn-icon" onclick="toggleDarkMode()" id="darkModeBtn">üåô</button>
    </div>

    <div class="tab-menu">
        <div class="tab-btn active" id="tab-daily" onclick="switchTab('daily')">üéØ Mode Daily</div>
        <div class="tab-btn" id="tab-event" onclick="switchTab('event')">üìç Mode Event</div>
    </div>

    <div id="loading">Sinkronisasi Database... ‚è≥</div>

    <div id="view-daily" class="view-section active">
        
        <div class="card">
            <h2>‚è™ Evaluasi Kemarin</h2>
            <ul class="missed-list" id="missedList">
                <li style="color: var(--text-muted); font-size: 13px;">Sedang memuat data...</li>
            </ul>
        </div>

        <div class="card">
            <h2>üéØ Fokus Rutinitas Hari Ini</h2>
            
            <div id="todayAgendaContainer" style="display:none; background: rgba(33, 150, 243, 0.05); padding: 15px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--blue);">
                <strong style="color: var(--blue); font-size: 14px; display:flex; align-items:center; gap:5px;">üìå Agenda Khusus:</strong>
                <ul class="habit-list" id="todayAgendaList" style="margin-top: 10px;"></ul>
            </div>

            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            <ul class="habit-list" id="habitList"></ul>
            
            <div class="add-habit">
                <div class="input-group">
                    <input type="text" id="newHabitInput" placeholder="Ketik rutinitas baru...">
                </div>
                <div class="input-group">
                    <select id="tagInput">
                        <option value="Pondok">üü¢ Pondok</option>
                        <option value="Angkatan">üîµ Angkatan</option>
                        <option value="Pribadi">üü† Pribadi</option>
                        <option value="Lainnya" selected>‚ö™ Lainnya</option>
                    </select>
                    <button class="btn-add" onclick="addHabit()">Tambah</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>‚è© Catatan & Agenda Besok</h2>
            <div class="agenda-input">
                <textarea id="agendaTomorrow" placeholder="Tulis hal penting untuk besok..."></textarea>
                <button class="btn-agenda" onclick="saveAgenda()">Simpan ke Database</button>
            </div>
        </div>

        <button class="btn-sync" id="btnSync" onclick="saveToday()">Simpan Rekap Harian</button>
    </div>

    <div id="view-event" class="view-section">
        <div class="countdown-box">
            <div id="countdownLabel" style="font-size: 12px; opacity: 0.9;">Menuju Agenda Berikutnya:</div>
            <div class="countdown-time" id="countdownTimer">00:00:00</div>
            <div id="nextEventName" style="font-size: 14px;">Memuat jadwal...</div>
        </div>

        <div class="card">
            <h2>üìç Rundown & Timeline</h2>
            <div class="timeline" id="eventTimeline"></div>
        </div>

        <div class="card">
            <h2>‚öôÔ∏è Atur Jadwal Event</h2>
            <div class="event-form">
                <div class="input-group">
                    <input type="time" id="evStart" required>
                    <span style="display:flex; align-items:center;">-</span>
                    <input type="time" id="evEnd" required>
                </div>
                <div class="input-group">
                    <input type="text" id="evIcon" placeholder="Ikon (misal: ‚òï)" style="width: 60px; flex: none;">
                    <input type="text" id="evTitle" placeholder="Judul Agenda" required>
                </div>
                <input type="text" id="evDesc" placeholder="Keterangan / Deskripsi detail...">
                <button class="btn-add" onclick="saveEvent()" id="btnSaveEvent" style="width: 100%;">Tambah Jadwal</button>
                <input type="hidden" id="evEditIndex" value="-1">
            </div>
        </div>
    </div>

</div>

<script>
    // ======================================================================
    // PASTE URL APPS SCRIPT ANDA DI ANTARA TANDA KUTIP DI BAWAH INI:
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzxmna0szVmBrWhMmznXkuq519TRzahIJDzBhrmEnM5b6g0GOEuzzuwmRpP5z_ndSb5UQ/exec"; 
    // ======================================================================

    // 1. PENGATURAN AWAL & TEMA
    const today = new Date();
    document.getElementById('dateTodayHeader').innerText = today.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });

    const hour = today.getHours();
    let greeting = "Selamat Pagi!";
    if (hour >= 11 && hour < 15) greeting = "Selamat Siang!";
    else if (hour >= 15 && hour < 18) greeting = "Selamat Sore!";
    else if (hour >= 18) greeting = "Selamat Malam!";
    document.getElementById('greetingText').innerText = greeting;

    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeBtn').innerText = '‚òÄÔ∏è';
    }
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('darkMode', isDark);
        document.getElementById('darkModeBtn').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
    }

    // 2. SWITCH TAB
    function switchTab(tabName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${tabName}`).classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
        if(tabName === 'event') updateTimeline();
    }

    // ======================================================================
    // 3. LOGIKA AGENDA KHUSUS (BARU: INTERAKTIF)
    // ======================================================================
    let todayAgendas = JSON.parse(localStorage.getItem('myTodayAgendasPro')) || [];

    function saveAndRenderAgendas() {
        localStorage.setItem('myTodayAgendasPro', JSON.stringify(todayAgendas));
        const container = document.getElementById('todayAgendaContainer');
        const listEl = document.getElementById('todayAgendaList');
        
        if (todayAgendas.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        listEl.innerHTML = '';
        todayAgendas.forEach((a, i) => {
            listEl.innerHTML += `
                <li class="habit-item" style="border-bottom: 1px dashed rgba(33,150,243,0.3); padding: 8px 0;">
                    <div class="habit-info">
                        <input type="checkbox" onchange="toggleAgenda(${i})" ${a.status ? 'checked' : ''}>
                        <span style="font-weight: 500; font-size: 14px; text-decoration: ${a.status ? 'line-through' : 'none'}; opacity: ${a.status ? '0.6' : '1'}; color: var(--text-dark);">${a.name}</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button style="background:none; border:none; cursor:pointer; font-size:14px; padding:0;" onclick="editAgenda(${i})" title="Edit">‚úèÔ∏è</button>
                        <button style="background:none; border:none; cursor:pointer; font-size:14px; padding:0;" onclick="snoozeAgenda(${i})" title="Undur Besok">‚û°Ô∏è</button>
                    </div>
                </li>
            `;
        });
    }

    function toggleAgenda(i) { todayAgendas[i].status = !todayAgendas[i].status; saveAndRenderAgendas(); }
    
    function editAgenda(i) {
        let newName = prompt("Edit nama agenda khusus ini:", todayAgendas[i].name);
        if(newName && newName.trim() !== "") {
            todayAgendas[i].name = newName.trim();
            saveAndRenderAgendas();
        }
    }

    function snoozeAgenda(i) {
        const taskName = todayAgendas[i].name;
        const txt = document.getElementById('agendaTomorrow');
        txt.value = txt.value ? txt.value + '\n- ' + taskName : '- ' + taskName;
        todayAgendas.splice(i, 1); // Hapus dari hari ini
        saveAndRenderAgendas();
        alert(`Agenda "${taskName}" berhasil diundur dan dipindah ke draf Catatan Besok!`);
    }

    // ======================================================================
    // 4. LOGIKA HABIT & SERVER
    // ======================================================================
    let habits = JSON.parse(localStorage.getItem('myHabitsFinal')) || [];
    const tagColors = { "Pondok": "#4CAF50", "Angkatan": "#2196F3", "Pribadi": "#FF9800", "Lainnya": "#9E9E9E" };

    function saveAndRenderHabits() { localStorage.setItem('myHabitsFinal', JSON.stringify(habits)); renderHabits(); }

    function renderHabits() {
        const habitListEl = document.getElementById('habitList');
        habitListEl.innerHTML = '';
        let completed = 0;
        habits.forEach((h, i) => {
            if (h.status) completed++;
            habitListEl.innerHTML += `
                <li class="habit-item">
                    <div class="habit-info">
                        <input type="checkbox" onchange="toggleHabit(${i})" ${h.status ? 'checked' : ''}>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <span style="font-weight: 500; text-decoration: ${h.status ? 'line-through' : 'none'}; opacity: ${h.status ? '0.6' : '1'};">${h.name}</span>
                            <span class="tag-badge" style="background: ${h.color}20; color: ${h.color}; width: fit-content;">${h.tag}</span>
                        </div>
                    </div>
                    <button style="background:none; border:none; cursor:pointer;" onclick="deleteHabit(${i})">üóëÔ∏è</button>
                </li>
            `;
        });
        document.getElementById('progressFill').style.width = habits.length ? (completed / habits.length) * 100 + '%' : '0%';
    }

    function toggleHabit(i) { habits[i].status = !habits[i].status; saveAndRenderHabits(); }
    function addHabit() {
        const name = document.getElementById('newHabitInput').value.trim();
        const tag = document.getElementById('tagInput').value;
        if (name) { habits.push({ name: name, status: false, tag: tag, color: tagColors[tag] }); document.getElementById('newHabitInput').value = ""; saveAndRenderHabits(); }
    }
    function deleteHabit(i) { if(confirm("Hapus rutinitas?")) { habits.splice(i, 1); saveAndRenderHabits(); } }

    function fetchServerData() {
        if(SCRIPT_URL.includes("PASTE_URL")) { document.getElementById('missedList').innerHTML = '<li style="color:red;">URL Script belum diganti!</li>'; return; }
        document.getElementById('loading').style.display = 'block';
        fetch(SCRIPT_URL).then(res => res.json()).then(data => {
            document.getElementById('loading').style.display = 'none';
            const missedUl = document.getElementById('missedList');
            if (data.kemarinBelumSelesai && data.kemarinBelumSelesai.length > 0) {
                missedUl.innerHTML = data.kemarinBelumSelesai.map(task => `<li><span class="task-name-missed">‚ö†Ô∏è ${task}</span><button class="btn-snooze" onclick="snoozeTask('${task}')">Tunda ‚û°Ô∏è</button></li>`).join('');
            } else {
                missedUl.innerHTML = '<li style="color: var(--primary); font-style: italic;">Luar biasa! Kemarin semua tuntas. üéâ</li>';
            }
            
            // Masukkan data Agenda Khusus ke array lokal agar interaktif
            if (data.agendaHariIni && data.agendaHariIni.length > 0) {
                data.agendaHariIni.forEach(task => {
                    // Cek duplikasi agar tidak bertumpuk jika di-refresh
                    if (!todayAgendas.find(a => a.originalName === task || a.name === task)) {
                        todayAgendas.push({ name: task, originalName: task, status: false, tag: "Agenda" });
                    }
                });
                saveAndRenderAgendas();
            }
        }).catch(err => { 
            document.getElementById('loading').style.display = 'none'; 
            document.getElementById('missedList').innerHTML = '<li style="color: red;">Gagal memuat data dari Database.</li>';
        });
    }

    window.snoozeTask = function(taskName) {
        const txt = document.getElementById('agendaTomorrow');
        txt.value = txt.value ? txt.value + '\n- Lanjutan: ' + taskName : '- Lanjutan: ' + taskName;
        alert(`"${taskName}" dipindah ke draf Besok. Klik 'Simpan ke Database' nanti.`);
    }

    function saveToday() {
        if(SCRIPT_URL.includes("PASTE_URL")) return alert("Ganti URL Apps Script!");
        const btn = document.getElementById('btnSync'); btn.innerText = "Menyimpan... ‚è≥";
        
        // Gabungkan Habit dan Agenda Khusus untuk dikirim ke Database
        const allDataToSave = [...habits, ...todayAgendas];

        fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: "saveToday", data: allDataToSave }) })
        .then(() => { 
            alert("Tersimpan di Database!"); 
            btn.innerText = "Tersimpan ‚úì"; 
            setTimeout(() => { btn.innerText = "Simpan Rekap Harian"; }, 3000); 

            if(confirm("Apakah Anda ingin mereset semua rutinitas untuk persiapan besok?")) {
                habits.forEach(h => h.status = false);
                saveAndRenderHabits();
                todayAgendas = []; // Agenda khusus hari ini dibersihkan
                saveAndRenderAgendas();
            }
        });
    }

    function saveAgenda() {
        const text = document.getElementById('agendaTomorrow').value.trim();
        if(!text) return alert("Isi agenda dulu!");
        const btn = document.querySelector('.btn-agenda'); btn.innerText = "Menyimpan... ‚è≥";
        fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: "saveTomorrow", agenda: text }) })
        .then(() => { alert("Agenda besok dicatat!"); document.getElementById('agendaTomorrow').value = ""; btn.innerText = "Simpan ke Database"; });
    }

    // ======================================================================
    // 5. LOGIKA EVENT DINAMIS (RUNDOWN)
    // ======================================================================
    const defaultEvents = [
        { start: "14:00", end: "15:00", title: "Kumpul Wali Kelas", desc: "Rapat asrama", icon: "üë•" },
        { start: "15:30", end: "17:30", title: "Artos Mall", desc: "Jalan santai", icon: "üõçÔ∏è" },
        { start: "20:30", end: "22:00", title: "Kolam Air Panas", desc: "Healing & Berenang", icon: "üèä‚Äç‚ôÇÔ∏è" }
    ];

    let events = JSON.parse(localStorage.getItem('myEventsPro')) || defaultEvents;

    function saveAndRenderEvents() {
        events.sort((a, b) => a.start.localeCompare(b.start));
        localStorage.setItem('myEventsPro', JSON.stringify(events));
        updateTimeline();
    }

    function updateTimeline() {
        const timelineEl = document.getElementById('eventTimeline');
        timelineEl.innerHTML = '';
        if(events.length === 0) { timelineEl.innerHTML = '<p style="color:var(--text-muted); font-size:13px;">Belum ada jadwal event.</p>'; return; }

        const now = new Date();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();

        events.forEach((ev, i) => {
            const [sh, sm] = ev.start.split(':').map(Number); const [eh, em] = ev.end.split(':').map(Number);
            const startMins = sh * 60 + sm; const endMins = eh * 60 + em;

            let statusClass = ''; let statusText = '';
            if (currentMinutes >= endMins) { statusClass = 'past'; } 
            else if (currentMinutes >= startMins && currentMinutes < endMins) {
                statusClass = 'active'; statusText = '<span style="color:var(--primary); font-size:10px; background:rgba(76,175,80,0.1); padding:2px 6px; border-radius:10px;">SEKARANG</span>';
            }

            timelineEl.innerHTML += `
                <div class="event-item ${statusClass}">
                    <div class="event-header">
                        <div>
                            <div class="event-time">${ev.start} - ${ev.end}</div>
                            <div class="event-title">${ev.icon || 'üìå'} ${ev.title} ${statusText}</div>
                        </div>
                        <div class="event-actions">
                            <button onclick="editEvent(${i})">‚úèÔ∏è</button>
                            <button onclick="deleteEvent(${i})">üóëÔ∏è</button>
                        </div>
                    </div>
                    ${ev.desc ? `<p class="event-desc">${ev.desc}</p>` : ''}
                </div>
            `;
        });
    }

    function saveEvent() {
        const start = document.getElementById('evStart').value;
        const end = document.getElementById('evEnd').value;
        const title = document.getElementById('evTitle').value.trim();
        const desc = document.getElementById('evDesc').value.trim();
        const icon = document.getElementById('evIcon').value.trim();
        const editIndex = parseInt(document.getElementById('evEditIndex').value);

        if(!start || !end || !title) return alert("Jam mulai, selesai, dan Judul wajib diisi!");
        const newEvent = { start, end, title, desc, icon };
        if(editIndex > -1) { events[editIndex] = newEvent; document.getElementById('btnSaveEvent').innerText = "Tambah Jadwal"; } 
        else { events.push(newEvent); }

        document.getElementById('evStart').value = ''; document.getElementById('evEnd').value = '';
        document.getElementById('evTitle').value = ''; document.getElementById('evDesc').value = '';
        document.getElementById('evIcon').value = ''; document.getElementById('evEditIndex').value = '-1';
        saveAndRenderEvents();
    }

    function deleteEvent(index) { if(confirm(`Hapus jadwal "${events[index].title}"?`)) { events.splice(index, 1); saveAndRenderEvents(); } }

    function editEvent(index) {
        const ev = events[index];
        document.getElementById('evStart').value = ev.start; document.getElementById('evEnd').value = ev.end;
        document.getElementById('evTitle').value = ev.title; document.getElementById('evDesc').value = ev.desc || '';
        document.getElementById('evIcon').value = ev.icon || ''; document.getElementById('evEditIndex').value = index;
        document.getElementById('btnSaveEvent').innerText = "Simpan Perubahan";
        document.querySelector('.event-form').scrollIntoView({ behavior: 'smooth' });
    }

    function updateCountdown() {
        if(events.length === 0) return;
        const now = new Date(); const currentMinutes = now.getHours() * 60 + now.getMinutes();
        let targetEvent = null; let targetTimeMins = 0; let isOngoing = false;

        for (let ev of events) {
            const [sh, sm] = ev.start.split(':').map(Number); const [eh, em] = ev.end.split(':').map(Number);
            const startMins = sh * 60 + sm; const endMins = eh * 60 + em;
            if (currentMinutes >= startMins && currentMinutes < endMins) { targetEvent = ev; targetTimeMins = endMins; isOngoing = true; break; } 
            else if (currentMinutes < startMins) { targetEvent = ev; targetTimeMins = startMins; break; }
        }

        const cdLabel = document.getElementById('countdownLabel'); const cdTimer = document.getElementById('countdownTimer'); const nextName = document.getElementById('nextEventName');
        if (targetEvent) {
            let diffMins = targetTimeMins - currentMinutes; let h = Math.floor(diffMins / 60); let m = diffMins % 60; let s = 59 - now.getSeconds();
            cdLabel.innerText = isOngoing ? "Sisa Waktu Agenda Ini:" : "Menuju Agenda Berikutnya:";
            cdTimer.innerText = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            nextName.innerText = isOngoing ? `Selesai ${targetEvent.title}` : `Mulai ${targetEvent.title}`;
        } else {
            cdLabel.innerText = "Semua Agenda Selesai!"; cdTimer.innerText = "üéâ"; nextName.innerText = "Selamat beristirahat.";
        }
    }

    // Inisialisasi
    renderHabits();
    saveAndRenderAgendas(); // Render struktur lokal Agenda Khusus
    updateTimeline();
    fetchServerData(); // Tarik data baru dan gabungkan dengan lokal
    setInterval(updateCountdown, 1000);
    setInterval(updateTimeline, 60000);

</script>

</body>
</html>